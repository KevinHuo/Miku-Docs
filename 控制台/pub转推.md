# PUB 转推

七牛云提供的 PUB 转推服务，实现将直播流或者点播流转推至目标直播平台。  
若您需要将直播源进行多平台分发，或者需要将点播文件转成直播流进行分发，那即可使用 PUB 转推服务，快速拉取已有的直播流/点播视频，推送到指定的直播推流地址上。

---

# 业务场景

## 一、电视台 / 摄像头信号源分发
电视台多为 rtsp/hls 等协议，而且有拉流数量限制，需要使用互联网平台的直播服务进行直播分发。  
摄像头信号源大多数为 rtsp 协议，这个协议不适合在互联网平台分发观看，因此需要使用 PUB 服务将 rtsp 流转推至 rtmp 服务器，最后生成 rtmp/flv/hls 流进行分发。

## 二、伪直播场景
在线教育领域以及各类活动都会有伪直播场景，将已录制完成的文件作为直播流进行分发，这时可以使用 PUB 转推服务作为解决方案。

## 三、多平台分发
活动直播有时提供单路信号源，如果需要转推多家第三方直播平台，就可以使用 PUB 转推服务。

---

# 控制台 PUB 服务使用说明

## 一、创建任务

### 1. 进入控制台
进入七牛云控制台，选择 **视频直播 Pili → Pub 转推**，进入 Pub 转推页面。

![服务页面](http://pk0jd2tt5.bkt.clouddn.com/pub1.png)

### 2. 新建任务
进入任务列表页面，点击 **新建任务**，进入新建 PUB 转推任务弹窗。

![新建任务](http://pk0jd2tt5.bkt.clouddn.com/createpub.png)

---

## 配置参数及说明

| 配置项 | 配置参数 | 配置说明 |
| --- | --- | --- |
| **任务名称** | 英文字符 | 自定义任务名称，名称仅支持字母和数字，不超过 20 个字符 |
| **任务描述** | 中英文字符 | 自定义任务描述内容，支持中英文，不超过 32 个字符 |
| **拉流地址** | 1. 支持直播/点播<br>2. 支持多个拉流地址<br>3. 支持指定运营商：默认/电信/移动/联通 | 1. 多个拉流地址会在前一个拉流结束后进入下一个（常用于点播）<br>2. 支持直播拉流：rtmp / flv / hls / rtsp<br>支持点播拉流：m3u8 / flv / mp4（视频编码需为 h.264/h.265，音频需为 AAC）<br>3. 只有点播类型任务支持播放次数设置 |
| **推流地址** | 1. 支持多个推流地址<br>2. 支持指定运营商 | 1. 多个推流地址会同时转推（计费按倍数计算）<br>2. 支持推流协议：rtmp / srt |
| **播放次数** | 不循环 / 无限循环 / 指定循环次数 | 1. 仅点播类型支持播放次数<br>2. 达到播放次数或定时关闭时间任一条件后任务停止 |
| **定时开启** | 时间 | 设定任务开启时间 |
| **定时关闭** | 时间 | 设定任务关闭时间，需晚于开启时间 |
| **断流重试** | 时间 | 1. 任务失败或中断会在重试时间内不断尝试重连（每 10 秒重试一次，并记录推流时长）<br>2. 直播类型建议设置断流重试，点播一般不设置 |
| **状态通知** | 请求地址、FORM/JSON/GET、请求参数 | 1. 任务状态变化后会发送通知请求<br>2. 支持多种通知格式<br>3. 请求参数支持使用[魔法变量](https://developer.qiniu.com/pili/7326/parameters-that-pub)（Key:Value） |

### 特殊说明
- 转推中断 **3 秒后重连**  
- 连续中断 **5 次** 后状态变为 **失败**，任务终止

### 魔法变量
系统内置参数(statusCallback)
| 参数 Value | 说明 |
| --- | --- |
| $(taskID) | pub任务id |
| $(status) | pub任务状态 |
| $(startTime) | 最新一次pub任务开始时间 |
| $(stopTime) | 最新一次pub任务结束时间 |
| $(params) | pub任务运行参数 |

---

# 二、编辑任务

在任务列表中，选择已经创建成功的转推任务，点击右侧操作栏的 **编辑** 按钮，进入修改 PUB 转推任务界面。

![编辑任务](http://pk0jd2tt5.bkt.clouddn.com/editpub.png)

可编辑内容包括：

- 任务备注  
- 拉流地址  
- 推流地址  
- 播放循环次数  
- 定时开启 / 定时关闭  

> **注意：运行中的转推任务不允许编辑和删除。**

---

# 三、运行日志

运行日志为最近一次转推任务运行的日志信息，对专业知识要求较高，主要用于查看转推任务失败原因。

在转推失败时，若咨询售后，可以附带此运行日志，以便排查问题：  
https://support.qiniu.com/tickets/new/?space=直播云

![运行日志](http://pk0jd2tt5.bkt.clouddn.com/consolepub.png)

